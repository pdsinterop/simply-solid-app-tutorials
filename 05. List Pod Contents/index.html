<main>
  <section>
    <form data-simply-command="connect">
      <label>
        <input name="issuer" type="text" value="https://solidcommunity.net">
      </label>
      <button>Connect</button>
    </form>

    <button data-simply-command="disconnect">Disconnect</button>
  </section>

  <section>
    <h2>Session Data</h2>
    <p>Session ID: <span data-simply-field="session.info.sessionId"></span></p>
    <p>Logged in: <span data-simply-field="session.info.isLoggedIn"></span></p>
  </section>

  <section>
    <h2>Pod Data</h2>
    <p>
      <label>Web ID: <input data-simply-field="session.info.webId"></label>
      <button data-simply-command="readPod">Get Pod Data</button>
    </p>
    <table>
      <thead>
        <tr>
          <th>Subject</th>
          <th>Relationship</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody data-simply-list="podData">
        <template>
          <tr>
            <td data-simply-field="subject.value">{data.subject}</td>
            <td data-simply-field="predicate.value">{data.predicate}</td>
            <td data-simply-field="object.value">{data.object}</td>
          </tr>
        </template>
      </tbody>
    </table>
  </section>
</main>

<script src="https://cdn.simplyedit.io/1/simply-edit.js" data-simply-storage="none"></script>
<script src="https://unpkg.com/simplyview/dist/simply.everything.js"></script>
<script type="module">
  import { getDefaultSession } from 'https://cdn.skypack.dev/@inrupt/solid-client-authn-browser'
  import { Parser } from 'https://cdn.skypack.dev/n3'

  const defaultSession = getDefaultSession()

  const solidApp = simply.app({
    actions: {
      connect: (session, issuer) => {
        if (session.info && session.info.isLoggedIn === false) {
          return session.login({
            oidcIssuer: issuer,
            redirectUrl: window.location.href,
          })
        }

        return session.info
      },
      disconnect: session => session.logout(),
      fetchFromPod: (session, url) => session.fetch(url)
        .then(response => response.text()),
      getPodContents: (session, webIdUrl) => {
        webIdUrl.hash = ''

        return solidApp.actions.getPodUrl(session, webIdUrl)
          .then(podUrl => solidApp.actions.listContent(session, podUrl))
      },
      getPodUrl: function (session, webIdUrl) {
        const parser = new Parser({blankNodePrefix: '', baseIRI: webIdUrl.href})

        return solidApp.actions.fetchFromPod(session, webIdUrl.href)
          .then(text => parser.parse(text))
          .then(quads => quads.find(quad => quad.predicate.value.includes('pim/space#storage')).object.value)
          .then(podUrl => podUrl.endsWith('/')
            ? podUrl.slice(0, -1)
            : podUrl
          )
      },
      listContent: async (session, rootUrl) => {
        const parser = new Parser({blankNodePrefix: '', baseIRI: rootUrl})

        return solidApp.actions.fetchFromPod(session, rootUrl)
          .then(text => parser.parse(text))
      },
    },
    commands: {
      connect: (form, values) => solidApp.actions.connect(solidApp.view.session, values.issuer),
      disconnect: () => solidApp.actions.disconnect(solidApp.view.session),
      readPod: () => {
        const session = solidApp.view.session;
        const webIdUrl = new URL(session.info.webId);

        return solidApp.actions.getPodContents(session, webIdUrl)
          .then(podData => solidApp.view.podData = JSON.parse(JSON.stringify(podData)))
      }
    },
    view: {
      podData: [],
      session: defaultSession
    }
  })

  defaultSession.handleIncomingRedirect({url: window.location.href, restorePreviousSession: true})
</script>
